<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´ë¬´ë© ê²°ì œ í˜ì´ì§€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .product-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .product-description {
            color: #718096;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .product-price {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 25px;
        }

        .price-currency {
            font-size: 1rem;
            color: #a0aec0;
            font-weight: normal;
        }

        .btn-pay {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-pay:active {
            transform: translateY(0);
        }

        .btn-pay:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feature {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #4a5568;
        }

        .feature::before {
            content: 'âœ“';
            color: #48bb78;
            font-weight: bold;
            margin-right: 10px;
            width: 20px;
        }

        .subscription-badge {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .support-badge {
            display: inline-block;
            background: #ed8936;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .products {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ë¬´ë¬´ë© ì„œë¹„ìŠ¤</h1>
            <p>ë¬´ë¬´ë©ì˜ ì„œë¹„ìŠ¤ë¥¼ êµ¬ë…í•˜ê±°ë‚˜ í›„ì›í•´ì£¼ì„¸ìš”</p>
            <div id="test-mode-indicator" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-top: 15px; font-weight: 600;">
                ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ - ì‹¤ì œ ê²°ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
            </div>
        </div>

        <div class="products">
            <!-- ë¬´ë¬´ë© í™ˆí˜ì´ì§€ êµ¬ë… -->
            <div class="product-card">
                <span class="subscription-badge">êµ¬ë… ì„œë¹„ìŠ¤</span>
                <h2 class="product-title">ë¬´ë¬´ë© í™ˆí˜ì´ì§€ êµ¬ë…</h2>
                <p class="product-description">
                    ë¬´ë¬´ë©ì˜ ëª¨ë“  ì½˜í…ì¸ ì— ë¬´ì œí•œìœ¼ë¡œ ì ‘ê·¼í•˜ì„¸ìš”. ë§¤ì›” ì—…ë°ì´íŠ¸ë˜ëŠ” ìƒˆë¡œìš´ ì½˜í…ì¸ ì™€ ë…ì  ìë£Œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                </p>
                <div class="feature">í”„ë¦¬ë¯¸ì—„ ì½˜í…ì¸  ì ‘ê·¼</div>
                <div class="feature">ì›”ê°„ ë…ì  ìë£Œ ì œê³µ</div>
                <div class="feature">ìš°ì„  ê³ ê° ì§€ì›</div>
                <div class="feature">ê´‘ê³  ì—†ëŠ” í™˜ê²½</div>

                <div class="product-price">
                    â‚©9,900 <span class="price-currency">/ ì›”</span>
                </div>

                <button class="btn-pay" onclick="initiatePayment('subscription')">
                    <span class="btn-text">êµ¬ë…í•˜ê¸°</span>
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>ê²°ì œ ì²˜ë¦¬ì¤‘...</span>
                    </div>
                </button>
            </div>

            <!-- ë¬´ë¬´ë© í›„ì› -->
            <div class="product-card">
                <span class="support-badge">ì¼íšŒì„± í›„ì›</span>
                <h2 class="product-title">ë¬´ë¬´ë© í›„ì›í•˜ê¸°</h2>
                <p class="product-description">
                    ë¬´ë¬´ë©ì˜ ì§€ì†ì ì¸ ë°œì „ì„ ìœ„í•´ í›„ì›í•´ì£¼ì„¸ìš”. ì—¬ëŸ¬ë¶„ì˜ í›„ì›ì´ ë” ë‚˜ì€ ì½˜í…ì¸  ì œì‘ì— í° í˜ì´ ë©ë‹ˆë‹¤.
                </p>
                <div class="feature">í”„ë¡œì íŠ¸ ë°œì „ì— ê¸°ì—¬</div>
                <div class="feature">í›„ì›ì ëª…ë‹¨ì— ë“±ì¬</div>
                <div class="feature">ê°ì‚¬ ë©”ì‹œì§€ ì „ë‹¬</div>
                <div class="feature">ì»¤ë®¤ë‹ˆí‹° ë°°ì§€ íšë“</div>

                <div class="product-price">
                    â‚©3,000 <span class="price-currency">ì¼íšŒì„±</span>
                </div>

                <button class="btn-pay" onclick="initiatePayment('support')">
                    <span class="btn-text">í›„ì›í•˜ê¸°</span>
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>ê²°ì œ ì²˜ë¦¬ì¤‘...</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Polar API ì„¤ì •
        const TEST_MODE = true; // true: í…ŒìŠ¤íŠ¸ ëª¨ë“œ, false: í”„ë¡œë•ì…˜ ëª¨ë“œ

        const POLAR_CONFIG = {
            production: {
                token: 'polar_oat_yyWCD9ysqy5sJFf20HCVgoyr0p2Nutfkw1udE0WLF29',
                api_url: 'https://api.polar.sh'
            },
            test: {
                token: 'polar_oat_FFBic5tuXw9Kn2EoYoKEv2bFR1z9LVL92879e4PYTaU',
                api_url: 'https://sandbox-api.polar.sh'
            }
        };

        const POLAR_ACCESS_TOKEN = TEST_MODE ? POLAR_CONFIG.test.token : POLAR_CONFIG.production.token;
        const POLAR_API_URL = TEST_MODE ? POLAR_CONFIG.test.api_url : POLAR_CONFIG.production.api_url;
        const POLAR_ORGANIZATION_ID = '22babd7d-7b88-4177-b9c5-7f394520e19c';

        // ì œí’ˆ ì •ë³´ (í…ŒìŠ¤íŠ¸/í”„ë¡œë•ì…˜ ë¶„ë¦¬)
        const PRODUCT_IDS = {
            production: {
                subscription: '449b8858-a5cf-4233-91fe-d55995d005f3',
                support: '563f50c9-e176-49cb-8025-54e9fddb588a'
            },
            test: {
                subscription: 'ebc1c47b-e115-4ff1-92a3-780cddf50e36', // í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ë… Product ID
                support: 'b18d9f7f-2f7b-4675-b966-1e9f7836c57a' // í…ŒìŠ¤íŠ¸ í™˜ê²½ í›„ì› Product ID
            }
        };

        const currentProductIds = TEST_MODE ? PRODUCT_IDS.test : PRODUCT_IDS.production;

        const products = {
            subscription: {
                id: currentProductIds.subscription,
                name: 'ë¬´ë¬´ë© í™ˆí˜ì´ì§€ êµ¬ë…',
                price: 9900,
                currency: 'KRW',
                type: 'subscription',
                interval: 'month'
                // success_url ì œê±° - ê¸°ë³¸ ì„±ê³µ í˜ì´ì§€ ì‚¬ìš©
            },
            support: {
                id: currentProductIds.support,
                name: 'ë¬´ë¬´ë© í›„ì›í•˜ê¸°',
                price: 3000,
                currency: 'KRW',
                type: 'one_time'
                // success_url ì—†ìŒ - ê¸°ë³¸ ì„±ê³µ í˜ì´ì§€ ì‚¬ìš©
            }
        };

        async function initiatePayment(productType) {
            // í´ë¦­ëœ ìš”ì†Œê°€ ë²„íŠ¼ì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ë²„íŠ¼ ì°¾ê¸°
            const button = event.target.closest('.btn-pay');
            if (!button) {
                console.error('ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const btnText = button.querySelector('.btn-text');
            const loading = button.querySelector('.loading');

            // ìš”ì†Œ ì¡´ì¬ í™•ì¸
            if (!btnText || !loading) {
                console.error('ë²„íŠ¼ ë‚´ë¶€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            button.disabled = true;
            btnText.style.display = 'none';
            loading.style.display = 'flex';

            try {
                const product = products[productType];

                // Polar APIë¥¼ í†µí•œ ê²°ì œ ë§í¬ ìƒì„±
                const checkoutSession = await createCheckoutSession(product);

                if (checkoutSession && checkoutSession.url) {
                    // ê²°ì œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = checkoutSession.url;
                } else {
                    throw new Error('ê²°ì œ ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                if (button && btnText && loading) {
                    button.disabled = false;
                    btnText.style.display = 'inline';
                    loading.style.display = 'none';
                }
            }
        }

        async function createCheckoutSession(product) {
            // Polar API í˜¸ì¶œ ì˜ˆì‹œ (ì‹¤ì œ êµ¬í˜„ì‹œ ì„œë²„ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬ ê¶Œì¥)
            const response = await fetch(`${POLAR_API_URL}/v1/checkouts/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${POLAR_ACCESS_TOKEN}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    products: [product.id],
                    success_url: product.success_url || 'https://fightingmumulab.netlify.app/success.html',
                    cancel_url: 'https://fightingmumulab.netlify.app/',
                    metadata: {
                        product_type: product.type,
                        product_name: product.name
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Polar API Error Response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
            }

            return await response.json();
        }

        // ë²„íŠ¼ ìƒíƒœ ë³µì› í•¨ìˆ˜
        function resetAllButtons() {
            const buttons = document.querySelectorAll('.btn-pay');
            buttons.forEach(button => {
                const btnText = button.querySelector('.btn-text');
                const loading = button.querySelector('.loading');

                button.disabled = false;
                btnText.style.display = 'inline';
                loading.style.display = 'none';
            });
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ë¬´ë¬´ë© ê²°ì œ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');

            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ í‘œì‹œ
            if (TEST_MODE) {
                document.getElementById('test-mode-indicator').style.display = 'block';
                console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™œì„±í™” - ì‹¤ì œ ê²°ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }

            // Polar API í† í° í™•ì¸
            if (POLAR_ACCESS_TOKEN.includes('YOUR_TEST_TOKEN_HERE') || POLAR_ACCESS_TOKEN === 'your_polar_access_token_here') {
                console.warn('Polar API í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‹¤ì œ í† í°ìœ¼ë¡œ êµì²´í•´ì£¼ì„¸ìš”.');
            }

            // Product ID í™•ì¸
            if (TEST_MODE && (currentProductIds.subscription.includes('TEST_') || currentProductIds.support.includes('TEST_'))) {
                console.warn('âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ Product IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Polar í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì œí’ˆì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                alert('í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n1. Polar ëŒ€ì‹œë³´ë“œì—ì„œ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜\n2. ì œí’ˆ 2ê°œ ìƒì„±\n3. Product IDë¥¼ ì½”ë“œì— ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì¼ ë•Œ ë²„íŠ¼ ìƒíƒœ ë³µì› (ë’¤ë¡œê°€ê¸° ì‹œ)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    resetAllButtons();
                }
            });

            // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œì—ë„ ë²„íŠ¼ ìƒíƒœ ë³µì›
            window.addEventListener('focus', function() {
                resetAllButtons();
            });

            // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ê°ì§€
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    resetAllButtons();
                }
            });
        });
    </script>
</body>
</html>